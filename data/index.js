var Sequelize = require('sequelize'),
    fs = require('fs');

module.exports = function(app) {
  var sequelize = new Sequelize({
    dialect: process.env.DB_DIALECT,
    database: process.env.DB_DATABASE,
    host: process.env.DB_HOST,
    port: (process.env.DB_PORT ? process.env.DB_PORT : 1433),
    username: process.env.DB_USERNAME,
    password: process.env.DB_PASSWORD,
    logging: process.env.NODE_ENV === 'development' && process.env.DB_VERBOSE === 'true'? console.log: false,
    pool: {
        max: 5,
        min: 0,
        acquire: 20000,
        idle: 10000
    },
  });

  var models = {};

  fs.readdirSync(__dirname + '/models').forEach(function(filename) {
    if (filename !== 'autogenerated') {
      var model = sequelize.import(`${__dirname}/models/${filename}`);
      models[model.name] = model;
    }
  });

  Object.keys(models).forEach(function(modelName) {
    if ('associate' in models[modelName]) {
      models[modelName].associate(models);
    }
  });

  app.locals = Object.assign({}, app.locals, {
    sequelize,
    models
  });
}
